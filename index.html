<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T·∫°o ƒê·ªÅ Ki·ªÉm Tra - Gemini AI</title>
  <style>
    body {font-family: Arial, sans-serif; margin:0; padding:0; background:#f5f5f5;}
    header {background:#4CAF50; color:white; padding:15px; text-align:center;}
    main {max-width:800px; margin:20px auto; background:white; padding:20px; border-radius:8px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    label {display:block; margin-top:10px; font-weight:bold;}
    select, textarea {width:100%; padding:8px; margin-top:5px; border-radius:4px; border:1px solid #ccc;}
    button {margin-top:15px; padding:10px 15px; border:none; border-radius:5px; cursor:pointer; background:#4CAF50; color:white; font-weight:bold;}
    button:disabled {background:#aaa;}
    .hidden {display:none;}
    .output-container {margin-top:20px;}
    textarea.output {width:100%; height:200px; margin-top:10px;}
    .actions button {margin-right:10px;}
    .error {color:red; margin-top:10px;}
    .loading {margin-top:10px; font-style:italic;}
  </style>
</head>
<body>
  <header>
    <h1>‚úçÔ∏è ·ª®ng d·ª•ng t·∫°o ƒê·ªÅ ki·ªÉm tra THCS</h1>
    <p>S·ª≠ d·ª•ng Gemini AI</p>
  </header>
  <main>
    <form id="examForm">
      <label for="subject">M√¥n h·ªçc:</label>
      <select id="subject">
        <option value="To√°n">To√°n</option>
        <option value="Ng·ªØ vƒÉn">Ng·ªØ vƒÉn</option>
        <option value="Ti·∫øng Anh">Ti·∫øng Anh</option>
        <option value="V·∫≠t l√Ω">V·∫≠t l√Ω</option>
        <option value="H√≥a h·ªçc">H√≥a h·ªçc</option>
        <option value="Sinh h·ªçc">Sinh h·ªçc</option>
        <option value="L·ªãch s·ª≠">L·ªãch s·ª≠</option>
        <option value="ƒê·ªãa l√Ω">ƒê·ªãa l√Ω</option>
      </select>

      <label for="grade">Kh·ªëi l·ªõp:</label>
      <select id="grade">
        <option value="6">6</option>
        <option value="7">7</option>
        <option value="8">8</option>
        <option value="9">9</option>
      </select>

      <label for="topic">Ch·ªß ƒë·ªÅ / Ki·ªÉm tra:</label>
      <select id="topic">
        <option value="gi·ªØa k√¨ 1">Gi·ªØa k√¨ 1</option>
        <option value="cu·ªëi k√¨ 1">Cu·ªëi k√¨ 1</option>
        <option value="gi·ªØa k√¨ 2">Gi·ªØa k√¨ 2</option>
        <option value="cu·ªëi k√¨ 2">Cu·ªëi k√¨ 2</option>
      </select>

      <label for="notes">Ghi ch√∫ (n·∫øu c√≥):</label>
      <textarea id="notes" placeholder="V√≠ d·ª•: Gi·ªõi h·∫°n trong ch∆∞∆°ng Ph∆∞∆°ng tr√¨nh b·∫≠c nh·∫•t..."></textarea>

      <button type="button" id="generateButton">T·∫°o ƒë·ªÅ ki·ªÉm tra</button>
      <button type="button" id="createMatrixButton">T·∫°o ma tr·∫≠n ƒë·ªÅ</button>
      <button type="button" id="createTableButton">T·∫°o b·∫£ng ƒë·∫∑c t·∫£</button>
    </form>

    <div id="statusContainer" class="hidden">
      <p id="loadingIndicator" class="loading hidden">‚è≥ ƒêang x·ª≠ l√Ω, vui l√≤ng ch·ªù...</p>
      <p id="errorContainer" class="error hidden"></p>
    </div>

    <div id="examOutput" class="output-container hidden">
      <h2>K·∫øt qu·∫£:</h2>
      <h3>üìÑ Markdown</h3>
      <textarea id="markdownContent" class="output"></textarea>
      <div class="actions">
        <button id="copyMarkdownButton">üìã Copy</button>
        <button id="downloadMarkdownButton">‚¨áÔ∏è Download</button>
      </div>

      <h3>üìê LaTeX</h3>
      <textarea id="latexContent" class="output"></textarea>
      <div class="actions">
        <button id="copyLatexButton">üìã Copy</button>
        <button id="downloadLatexButton">‚¨áÔ∏è Download</button>
      </div>
    </div>
  </main>

  <script>
  const GEMINI_API_KEY = "AIzaSyD4Zg_Gr8d_WeSEexmc255aZqXFeetkABQ";   // üëâ D√°n API key tr·ª±c ti·∫øp v√†o ƒë√¢y
  const GEMINI_MODEL   = "gemini-2.5-flash";

  const gradeSelect = document.getElementById('grade');
  const topicSelect = document.getElementById('topic');
  const notesInput = document.getElementById('notes');
  const subjectSelect = document.getElementById('subject');
  const statusContainer = document.getElementById('statusContainer');
  const loadingIndicator = document.getElementById('loadingIndicator');
  const examOutput = document.getElementById('examOutput');
  const markdownContent = document.getElementById('markdownContent');
  const latexContent = document.getElementById('latexContent');
  const errorContainer = document.getElementById('errorContainer');

  const generateButton = document.getElementById('generateButton');
  const createMatrixButton = document.getElementById('createMatrixButton');
  const createTableButton = document.getElementById('createTableButton');

  const copyMarkdownButton = document.getElementById('copyMarkdownButton');
  const copyLatexButton = document.getElementById('copyLatexButton');
  const downloadMarkdownButton = document.getElementById('downloadMarkdownButton');
  const downloadLatexButton = document.getElementById('downloadLatexButton');

  function hideStates(){
    loadingIndicator.classList.add('hidden');
    examOutput.classList.add('hidden');
    errorContainer.classList.add('hidden');
    statusContainer.classList.add('hidden');
  }

  function setBusy(flag){
    [generateButton, createMatrixButton, createTableButton].forEach(b=>b.disabled=flag);
    if(flag){statusContainer.classList.remove('hidden'); loadingIndicator.classList.remove('hidden');}
    else{loadingIndicator.classList.add('hidden');}
  }

  function showError(msg){
    errorContainer.textContent = msg;
    errorContainer.classList.remove('hidden');
  }

  function buildPrompt(type){
    const grade = gradeSelect.value;
    const topic = topicSelect.value;
    const subject = subjectSelect.value;
    const notes = notesInput.value.trim();
    const scopeNote = notes?`\nGi·ªõi h·∫°n n·ªôi dung: ${notes}\n`:'';  
    if(type==='matrix') return `T·∫°o ma tr·∫≠n ƒë·ªÅ ki·ªÉm tra m√¥n ${subject} kh·ªëi ${grade}, k√¨ "${topic}".${scopeNote}\nCh·ªâ tr·∫£ l·ªùi Markdown r·ªìi LaTeX.`;  
    if(type==='table') return `T·∫°o b·∫£ng ƒë·∫∑c t·∫£ ƒë·ªÅ ki·ªÉm tra m√¥n ${subject} kh·ªëi ${grade}, k√¨ "${topic}".${scopeNote}\nCh·ªâ tr·∫£ l·ªùi Markdown r·ªìi LaTeX.`;  
    return `T·∫°o ƒë·ªÅ ki·ªÉm tra m√¥n ${subject} kh·ªëi ${grade}, k√¨ "${topic}".${scopeNote}\nMarkdown r·ªìi LaTeX.`;  
  }

  async function callGeminiAPI(prompt){
    if(!GEMINI_API_KEY) throw new Error('Thi·∫øu API key');
    const url = `https://generativelanguage.googleapis.com/v1beta/models/${encodeURIComponent(GEMINI_MODEL)}:generateContent?key=${encodeURIComponent(GEMINI_API_KEY)}`;
    const payload = { contents:[{parts:[{text:prompt}]}] };
    const res = await fetch(url,{method:'POST',headers:{'Content-Type':'application/json'},body: JSON.stringify(payload)});
    if(!res.ok) throw new Error('API l·ªói '+res.status);
    const data = await res.json();
    return data?.candidates?.[0]?.content?.parts?.map(p=>p.text).join('\n')||'';
  }

  function extractBlocks(text){
    const md = (text.match(/```markdown\n([\s\S]*?)```/i)||[])[1]||'';
    const tex = (text.match(/```latex\n([\s\S]*?)```/i)||[])[1]||'';
    return {md,tex};
  }

  async function handleGeneration(type){
    hideStates();
    setBusy(true);
    try{
      const prompt = buildPrompt(type);
      const result = await callGeminiAPI(prompt);
      const {md,tex} = extractBlocks(result);
      markdownContent.value = md;
      latexContent.value = tex;
      statusContainer.classList.remove('hidden');
      examOutput.classList.remove('hidden');
    }catch(e){
      showError(e.message||e);
    }finally{
      setBusy(false);
    }
  }

  async function copyToClipboard(text){
    try{await navigator.clipboard.writeText(text);}catch{
      const ta = document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove();
    }
  }
  function downloadFile(filename, content){
    const blob = new Blob([content], {type:'text/plain;charset=utf-8'});
    const a = document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click(); URL.revokeObjectURL(a.href);
  }

  // Events
  createMatrixButton.addEventListener('click', ()=>handleGeneration('matrix'));
  createTableButton.addEventListener('click', ()=>handleGeneration('table'));
  generateButton.addEventListener('click', e=>{ e.preventDefault(); handleGeneration('exam'); });

  copyMarkdownButton.addEventListener('click', ()=>copyToClipboard(markdownContent.value));
  copyLatexButton.addEventListener('click', ()=>copyToClipboard(latexContent.value));

  downloadMarkdownButton.addEventListener('click', ()=>downloadFile(`de-${subjectSelect.value}-${gradeSelect.value}-${topicSelect.value}.md`, markdownContent.value));
  downloadLatexButton.addEventListener('click', ()=>downloadFile(`de-${subjectSelect.value}-${gradeSelect.value}-${topicSelect.value}.tex`, latexContent.value));
  </script>
</body>
</html>
